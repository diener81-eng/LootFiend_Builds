<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lootborn Build Tracker</title>
  <style>
    :root{
      --bg:#0f1115;
      --panel:#1a1d24;
      --text:#e6e6e6;
      --muted:#b5b5b5;
      --border:#333;
      --ok:#7CFC98;
      --bad:#ff7a7a;
      --warn:#ffd27a;
      --btn:#222738;
      --btnActive:#2f3750;
      --red:#ff7a7a;
      --green:#7CFC98;
    }
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;}
    h1,h2,h3{margin:0 0 10px;}
    .container{max-width:1200px;margin:auto;}
    .topbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .small{color:var(--muted);font-size:0.92em;}

    .row{display:grid;grid-template-columns:1.1fr 0.9fr;gap:14px;align-items:start;}
    @media (max-width: 980px){.row{grid-template-columns:1fr;}}

    .card{background:var(--panel);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);}
    .hint{color:var(--muted);font-size:0.92em;line-height:1.3;}

    .inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:10px;}
    .slot{background:rgba(0,0,0,0.20);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:10px;}
    .slot label{display:block;font-weight:700;margin-bottom:6px;}

    button{cursor:pointer;background:var(--btn);color:var(--text);border:1px solid rgba(255,255,255,0.10);border-radius:10px;padding:10px 12px;font-weight:800;}
    button:hover{filter:brightness(1.08);} 
    button:active{transform:translateY(1px);} 

    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}

    .class-switch{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .class-btn{background:var(--btn);}
    .class-btn.active{background:var(--btnActive);border-color:rgba(255,255,255,0.20);}

    .toggle-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}

    .class-switch{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}
    .pill{cursor:pointer;background:#222738;color:var(--text);border:1px solid rgba(255,255,255,0.10);border-radius:999px;padding:10px 14px;font-weight:900;}
    .pill:hover{filter:brightness(1.08);} 
    .pill:active{transform:translateY(1px);} 
    .pill.active{outline:2px solid rgba(255,255,255,0.25);filter:brightness(1.12);}
    .toggle-row label{display:inline-flex;gap:8px;align-items:center;color:var(--muted);font-size:0.92em;user-select:none;}

    .build{background:rgba(0,0,0,0.20);border:1px solid rgba(255,255,255,0.08);padding:14px;border-radius:12px;margin-bottom:12px;}
    .meta{color:var(--muted);font-size:0.92em;margin-top:-6px;margin-bottom:8px;}
    .progress{font-weight:900;}
    .ok{color:var(--ok);font-weight:900;}
    .bad{color:var(--bad);font-weight:900;}
    .warn{color:var(--warn);font-weight:900;}

/* "Incomplete" label: different red, not bold */
.incomplete{
  color:#e32727;   
  font-weight:400; 
}
.ag-warning{
  color:#ff4d4d;
  font-size:0.9em;
  margin-top:4px;
}
    details{margin-top:10px;}
    summary{cursor:pointer;color:var(--muted);}
    ul{margin:8px 0 0 18px;padding:0;}
    li{margin:4px 0;}

    /* Item name coloring (default red, some green set pieces) */
    .item-red{color:var(--red);font-weight:800;}
    .item-green{color:var(--green);font-weight:800;}
    .item{color:var(--text);font-weight:800;}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>Lootborn Build Tracker v3.9</h1>
        <div class="small">Saves in your browser (no login). Arcanist and Savage are stored separately because their stash items are different.</div>
      </div>
      <div class="class-switch" role="group" aria-label="Class switch">
        <button id="btnArcanist" type="button" class="pill active">Arcanist Builds</button>
        <button id="btnSavage" type="button" class="pill">Savage Builds</button>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>Your Inventory</h2>
        <div class="hint">
          Check the items you own. This list is auto-generated from all items used in the builds (including substitutes).
          Your selections save automatically in your browser.
        </div>

        <div class="btn-row">
          <button id="saveBtn" type="button">Save now</button>
          <button id="clearBtn" type="button" title="Clears all saved inventory for the selected class">Clear inventory</button>
        </div>

        <div class="inv-grid" id="invGrid"></div>
      </div>

      <div class="card">
        <h2>Builds you are closest to</h2>
        <div class="toggle-row">
          <label><input type="checkbox" id="showPlayableOnly" /> Show playable only</label>
          <label><input type="checkbox" id="sortByOptimal" checked /> Sort by optimal percent</label>
        </div>
        <div id="buildResults" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <script>
    // Version marker: bump each revision so you can confirm the live site updated.
    const VERSION = "3.7";

    document.addEventListener("DOMContentLoaded", () => {
      // Keeps build detail panels open across re-renders
      const openDetails = new Set();
      function buildKey(b){
        return [b.class, b.coreSkill, b.build, b.variant].join("|");
      }
      const slots = [
        "weapon",
        "helmet",
        "pauldron",
        "cuirass",
        "gauntlet",
        "greaves",
        "boots",
        "bracers",
        "belt",
        "necklace",
        "amulet",
        "ring"
      ];

      const WIKI_BASE = "https://lootbornwarriors.miraheze.org/wiki/";

      // --- Name normalization (aliases) ---
      // Canonical spellings go on the RIGHT side.
      const NAME_ALIASES = {
        "ancient god call": "Ancient God's Call",
        "ancient gods call": "Ancient God's Call",
        "ancient god's call": "Ancient God's Call",
        "pack binding": "Pact Binding",
        "dragon hyun walker": "Dragon Hymn Walker"
      };

      function collapseSpaces(s) {
        let out = String(s || "");
        while (out.includes("  ")) out = out.replaceAll("  ", " ");
        return out;
      }

      function normalizeKey(s) {
        return collapseSpaces(String(s || "").trim().replaceAll("’", "'")).toLowerCase();
      }

      function normalizeItemName(name) {
        const raw = collapseSpaces(String(name || "").trim().replaceAll("’", "'"));
        if (!raw) return "";
        const key = normalizeKey(raw);
        return NAME_ALIASES[key] || raw;
      }

      // --- Slot labels & item color rules ---
      function slotLabel(slot){
        const map = {
          weapon: "Weapon",
          helmet: "Helmet",
          pauldron: "Pauldrons",
          cuirass: "Cuirass",
          gauntlet: "Gauntlets",
          greaves: "Greaves",
          boots: "Boots",
          bracers: "Bracers",
          belt: "Belt",
          necklace: "Necklace",
          amulet: "Amulet",
          ring: "Ring"
        };
        return map[slot] || titleCase(slot);
      }

      // Default gear names are red; these specific names are green.
      const GREEN_ITEMS = new Set([
        // Dragon Requiem / related
        "Dragon Claw Visage",
        "Dragon Bone Armor",
        "Dragon Soul Smile",
        "Dragon Spine Leggings",
        "Dragon Fury Grip",
        "Dragon Hymn Walker",
        "Fairy Whisper",
        "Dragon Scale Pauldrons",

        // Fate Weaver / Big Wind Blows pieces
        "Fate Weaver's Protection",
        "Fate Weaver's Desire",
        "Fate Weaver's Kindness",
        "Fate Weaver's Mercy",
        "Fate Weaver's Taking",
        "Fate Weaver's Benevolence",
        "Hiss",
        "Splash",
        "Swoosh",

        // Cryo Mark
        "Cryo Mark Robe",
        "Cryo Mark Trousers",
        "Cryo Mark Gloves",
        "Cryo Mark Boots",
        "Cryo Mark Crown",
        "Cryo Mark Waistband",
        "Cryo Mark Pauldrons",

        // Desolate
        "Desolate Cuirass",
        "Desolate Belt",
        "Desolate Greaves",
        "Desolate Boots",
        "Desolate Helm",

        // Scourge of Sin
        "Greed",
        "Envy",
        "Sloth",
        "Pride",
        "Lust",

        // Eternal Ruler
        "Eternal Ruler's Dominion",
        "Eternal Ruler's Design",
        "Eternal Ruler's Gaze",
        "Eternal Ruler's Mark",
        "Eternal Ruler's Shackles",
        "Eternal Ruler's Resolve"
      ].map(normalizeItemName));

      function itemClass(name){
        const n = normalizeItemName(name);
        return GREEN_ITEMS.has(n) ? "item-green" : "item-red";
      }

      function itemSpan(name){
        const n = normalizeItemName(name);
        return '<span class="' + itemClass(n) + '">' + escapeHtml(n) + '</span>';
      }

      // --- Separate storage per class (Arcanist vs Savage) ---
      const STORAGE_KEY_PREFIX = "lootborn_inventory_v3";
      function storageKeyFor(cls) {
        return STORAGE_KEY_PREFIX + "_" + String(cls || "").toLowerCase();
      }

      // Builds
      const builds = [
        // --- Arcanist builds ---
        {
          class: "Arcanist",
          coreSkill: "Fireball",
          build: "Iceflame",
          variant: "PvE",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Evil Spirit Skull",
            cuirass: "Void Cavity",
            belt: "Resurrection",
            greaves: "Void Hip",
            pauldron: "Fairy Whisper",
            bracers: "Dragon Roar Mark",
            gauntlet: "Void Arm",
            boots: "Void Shin",
            necklace: "Balance Chain",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            boots: ["Planar Shortcut"],
            amulet: ["Overflow Amulet"],
            belt: ["Viper Bond"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Fireball",
          build: "Iceflame",
          variant: "Ancient God PvE",
          gear: {
            weapon: "Ancient God's Call",
            helmet: "Dragon Claw Visage",
            cuirass: "Dragon Bone Armor",
            belt: "Dragon Soul Smile",
            greaves: "Dragon Spine Leggings",
            pauldron: "Fairy Whisper",
            bracers: "Dragon Roar Mark",
            gauntlet: "Dragon Fury Grip",
            boots: "Dragon Hymn Walker",
            necklace: "Temporal Pendant",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            amulet: ["Overflow Amulet"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Fireball",
          build: "Pyroblast",
          variant: "PvE",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Dragon Claw Visage",
            cuirass: "Dragon Bone Armor",
            belt: "Dragon Soul Smile",
            greaves: "Dragon Spine Leggings",
            pauldron: "Void Scapula",
            bracers: "Dragon Roar Mark",
            gauntlet: "Void Arm",
            boots: "Void Shin",
            necklace: "Balance Chain",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            gauntlet: ["Firm Grip"],
            amulet: ["Holy Shelter"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Fireball",
          build: "Pyroblast",
          variant: "Ancient God PvE",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Dragon Claw Visage",
            cuirass: "Dragon Bone Armor",
            belt: "Dragon Soul Smile",
            greaves: "Dragon Spine Leggings",
            pauldron: "Fairy Whisper",
            bracers: "Dragon Roar Mark",
            gauntlet: "Dragon Fury Grip",
            boots: "Void Shin",
            necklace: "Temporal Pendant",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            greaves: ["Pact Binding"],
            gauntlet: ["Void Arm"],
            amulet: ["Holy Shelter"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Fireball",
          build: "Pyroblast",
          variant: "PvP",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Dragon Claw Visage",
            cuirass: "Dragon Bone Armor",
            belt: "Dragon Soul Smile",
            greaves: "Dragon Spine Leggings",
            pauldron: "Void Scapula",
            bracers: "Dragon Roar Mark",
            gauntlet: "Void Arm",
            boots: "Planar Shortcut",
            necklace: "Balance Chain",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            gauntlet: ["Firm Grip"],
            amulet: ["Threshold Mark"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Fireball",
          build: "Jolt",
          variant: "Ancient God PvE",
          gear: {
            weapon: "Ancient God's Call",
            helmet: "Dragon Claw Visage",
            cuirass: "Dragon Bone Armor",
            belt: "Dragon Soul Smile",
            greaves: "Dragon Spine Leggings",
            pauldron: "Dragon Scale Pauldrons",
            bracers: "Enigmatic Imprint",
            gauntlet: "Void Arm",
            boots: "Dragon Hymn Walker",
            necklace: "Temporal Pendant",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            amulet: ["Holy Shelter"],
            boots: ["Void Shin"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Lightning Punch",
          build: "Ice Sword",
          variant: "PvE",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Evil Spirit Skull",
            cuirass: "Fate Weaver's Protection",
            belt: "Viper Bond",
            greaves: "Fate Weaver's Desire",
            pauldron: "Fairy Whisper",
            bracers: "Stellar Spindle",
            gauntlet: "Void Arm",
            boots: "Void Shin",
            necklace: "Balance Chain",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            pauldron: ["Elemental Disruption", "Void Scapula"],
            weapon: ["Sage's Tear"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Lightning Punch",
          build: "Ice Sword",
          variant: "PvP",
          gear: {
            weapon: "Prism",
            helmet: "Fate Weaver's Kindness",
            cuirass: "Fate Weaver's Protection",
            belt: "Viper Bond",
            greaves: "Pact Binding",
            pauldron: "Elemental Disruption",
            bracers: "Stellar Spindle",
            gauntlet: "Void Arm",
            boots: "Planar Shortcut",
            necklace: "Balance Chain",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            boots: ["Scholar's Journey"],
            bracers: ["Enigmatic Imprint"],
            weapon: ["Fate Intertwined"],
            belt: ["Void Abdomen"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Lightning Punch",
          build: "Flame Bow",
          variant: "PvE",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Evil Spirit Skull",
            cuirass: "Void Cavity",
            belt: "Resurrection",
            greaves: "Fate Weaver's Desire",
            pauldron: "Fate Weaver's Mercy",
            bracers: "Stellar Spindle",
            gauntlet: "Void Arm",
            boots: "Void Shin",
            necklace: "Balance Chain",
            amulet: "End's Return",
            ring: "Lucky Echo"
          },
          alternatives: {
            boots: ["Planar Shortcut"],
            ring: ["Swift Shadow Finger"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Lightning Punch",
          build: "Thunder Punch",
          variant: "PvE",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Fate Weaver's Kindness",
            cuirass: "Fel Heritage Robe",
            belt: "Viper Bond",
            greaves: "Fate Weaver's Desire",
            pauldron: "Elemental Disruption",
            bracers: "Stellar Spindle",
            gauntlet: "Void Arm",
            boots: "Void Shin",
            necklace: "Balance Chain",
            amulet: "End's Return",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            boots: ["Planar Shortcut"],
            amulet: ["Threshold Mark"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Lightning Punch",
          build: "Thunder Punch",
          variant: "PvP",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Fate Weaver's Kindness",
            cuirass: "Fate Weaver's Protection",
            belt: "Fate Weaver's Taking",
            greaves: "Fate Weaver's Desire",
            pauldron: "Fate Weaver's Mercy",
            bracers: "Stellar Spindle",
            gauntlet: "Void Arm",
            boots: "Fate Weaver's Benevolence",
            necklace: "Balance Chain",
            amulet: "Threshold Mark",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            necklace: ["Swoosh"],
            amulet: ["Splash"],
            ring: ["Hiss"],
            cuirass: ["Fel Heritage Robe"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Ice Ray",
          build: "Rimebite",
          variant: "PvE",
          gear: {
            weapon: "Lich Remains",
            helmet: "Evil Spirit Skull",
            cuirass: "Cryo Mark Robe",
            belt: "Viper Bond",
            greaves: "Cryo Mark Trousers",
            pauldron: "Void Scapula",
            bracers: "Sorrow Bracers",
            gauntlet: "Cryo Mark Gloves",
            boots: "Cryo Mark Boots",
            necklace: "Temporal Pendant",
            amulet: "Holy Shelter",
            ring: "Winter Guard"
          },
          alternatives: {
            necklace: ["Balance Chain"],
            pauldron: ["Fairy Whisper"],
            ring: ["Swift Shadow Finger"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Ice Ray",
          build: "Rimebite",
          variant: "PvP",
          gear: {
            weapon: "Fate Intertwined",
            helmet: "Cryo Mark Crown",
            cuirass: "Cryo Mark Robe",
            belt: "Cryo Mark Waistband",
            greaves: "Cryo Mark Trousers",
            pauldron: "Fairy Whisper",
            bracers: "Sorrow Bracers",
            gauntlet: "Deathspeaker",
            boots: "Planar Shortcut",
            necklace: "Swoosh",
            amulet: "Splash",
            ring: "Hiss"
          },
          alternatives: {}
        },
        {
          class: "Arcanist",
          coreSkill: "Ice Ray",
          build: "Pyresight",
          variant: "PvE",
          gear: {
            weapon: "Lich Remains",
            helmet: "Cryo Mark Crown",
            cuirass: "Void Cavity",
            belt: "Resurrection",
            greaves: "Cryo Mark Trousers",
            pauldron: "Cryo Mark Pauldrons",
            bracers: "Sorrow Bracers",
            gauntlet: "Void Arm",
            boots: "Cryo Mark Boots",
            necklace: "Temporal Pendant",
            amulet: "Threshold Mark",
            ring: "Swift Shadow Finger"
          },
          alternatives: {
            weapon: ["Fate Intertwined"],
            necklace: ["Balance Chain"],
            ring: ["Winter Guard"]
          }
        },
        {
          class: "Arcanist",
          coreSkill: "Ice Ray",
          build: "Ionization",
          variant: "PvE",
          gear: {
            weapon: "Lich Remains",
            helmet: "Cryo Mark Crown",
            cuirass: "Fel Heritage Robe",
            belt: "Cryo Mark Waistband",
            greaves: "Cryo Mark Trousers",
            pauldron: "Cryo Mark Pauldrons",
            bracers: "Sorrow Bracers",
            gauntlet: "Void Arm",
            boots: "Void Shin",
            necklace: "Balance Chain",
            amulet: "Threshold Mark",
            ring: "Swift Shadow Finger"
          },
          alternatives: {}
        },

        // --- Savage builds ---
        {
          class: "Savage",
          coreSkill: "Bladestorm",
          build: "Thunder",
          variant: "PvE",
          gear: {
            weapon: "Tribal Reverence",
            helmet: "Crown of Madness",
            cuirass: "Desolate Cuirass",
            belt: "Desolate Belt",
            greaves: "Desolate Greaves",
            pauldron: "Demonbane Pauldron",
            bracers: "Might of Fury",
            gauntlet: "Ancestral Legacy",
            boots: "Desolate Boots",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Dragon's Might"
          },
          alternatives: {
            cuirass: ["Conqueror Soul"],
            gauntlet: ["Ruler's Gauntlets"],
            amulet: ["Eye of Thunder"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Bladestorm",
          build: "Thunder",
          variant: "PvP",
          gear: {
            weapon: "Ancestor",
            helmet: "Desolate Helm",
            cuirass: "Desolate Cuirass",
            belt: "Desolate Belt",
            greaves: "Desolate Greaves",
            pauldron: "Demonbane Pauldron",
            bracers: "Might of Fury",
            gauntlet: "Ruler's Gauntlets",
            boots: "Bloodclaw Sabatons",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Dragon's Might"
          },
          alternatives: {
            gauntlet: ["Gladiator's Force"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Bladestorm",
          build: "Fiery Rage",
          variant: "PvE",
          gear: {
            weapon: "Tribal Reverence",
            helmet: "Crown of Decay",
            cuirass: "Desolate Cuirass",
            belt: "Desolate Belt",
            greaves: "Desolate Greaves",
            pauldron: "Demonbane Pauldron",
            bracers: "Might of Fury",
            gauntlet: "Ancestral Legacy",
            boots: "Desolate Boots",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Dragon's Might"
          },
          alternatives: {
            helmet: ["Crown of Madness"],
            gauntlet: ["Ruler's Gauntlets"],
            amulet: ["Eye of Thunder"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Bladestorm",
          build: "Fiery Rage",
          variant: "PvP",
          gear: {
            weapon: "Ancestor",
            helmet: "Desolate Helm",
            cuirass: "Desolate Cuirass",
            belt: "Desolate Belt",
            greaves: "Desolate Greaves",
            pauldron: "Demonbane Pauldron",
            bracers: "Might of Fury",
            gauntlet: "Ancestral Legacy",
            boots: "Bloodclaw Sabatons",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {}
        },
        {
          class: "Savage",
          coreSkill: "Bladestorm",
          build: "Thorn",
          variant: "PvE",
          gear: {
            weapon: "Demonic Barb",
            helmet: "Crest of Silence",
            cuirass: "Conqueror Soul",
            belt: "Desolate Belt",
            greaves: "Desolate Greaves",
            pauldron: "Demonbane Pauldron",
            bracers: "Might of Fury",
            gauntlet: "Ancestral Legacy",
            boots: "Bloodclaw Sabatons",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Dragon's Might"
          },
          alternatives: {
            helmet: ["Crown of Madness"],
            gauntlet: ["Ruler's Gauntlets"],
            amulet: ["Eye of Thunder"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Bladestorm",
          build: "Thorn",
          variant: "PvP",
          gear: {
            weapon: "Ancestor",
            helmet: "Crown of Madness",
            cuirass: "Conqueror Soul",
            belt: "Desolate Belt",
            greaves: "Rootguard Vessel",
            pauldron: "Demonbane Pauldron",
            bracers: "Might of Fury",
            gauntlet: "Gladiator's Force",
            boots: "Bloodclaw Sabatons",
            necklace: "Behemoth Gorget",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {}
        },
        {
          class: "Savage",
          coreSkill: "Swipe",
          build: "Blazefury",
          variant: "PvE",
          gear: {
            weapon: "Tribal Reverence",
            helmet: "Crown of Decay",
            cuirass: "Greed",
            belt: "Ghost Girdle",
            greaves: "Envy",
            pauldron: "Demonbane Pauldron",
            bracers: "Demon Slayer",
            gauntlet: "Sloth",
            boots: "Pride",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {}
        },
        {
          class: "Savage",
          coreSkill: "Swipe",
          build: "Blazefury",
          variant: "PvP",
          gear: {
            weapon: "Ancestor",
            helmet: "Crown of Madness",
            cuirass: "Greed",
            belt: "Ghost Girdle",
            greaves: "Envy",
            pauldron: "Demonbane Pauldron",
            bracers: "Demon Slayer",
            gauntlet: "Sloth",
            boots: "Pride",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {}
        },
        {
          class: "Savage",
          coreSkill: "Swipe",
          build: "Wild Spark",
          variant: "PvE",
          gear: {
            weapon: "Tribal Reverence",
            helmet: "Crown of Madness",
            cuirass: "Greed",
            belt: "Ghost Girdle",
            greaves: "Envy",
            pauldron: "Demonbane Pauldron",
            bracers: "Demon Slayer",
            gauntlet: "Sloth",
            boots: "Pride",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {
            helmet: ["Crown of Decay"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Swipe",
          build: "Ritual Blade",
          variant: "PvE",
          gear: {
            weapon: "Tribal Reverence",
            helmet: "Crown of Madness",
            cuirass: "Conqueror Soul",
            belt: "Lust",
            greaves: "Envy",
            pauldron: "Deathguard Pauldron",
            bracers: "Demon Slayer",
            gauntlet: "Sloth",
            boots: "Pride",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {
            helmet: ["Crown of Decay"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Heavy Blow",
          build: "Hellfire",
          variant: "PvE",
          gear: {
            weapon: "Tribal Reverence",
            helmet: "Crown of Madness",
            cuirass: "Eternal Ruler's Dominion",
            belt: "Eternal Ruler's Design",
            greaves: "Eternal Ruler's Gaze",
            pauldron: "Demonbane Pauldron",
            bracers: "Hand of Annihilation",
            gauntlet: "Ruler's Gauntlets",
            boots: "Eternal Ruler's Mark",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Dragon's Might"
          },
          alternatives: {
            gauntlet: ["Ancestral Legacy", "Eternal Ruler's Shackles"],
            boots: ["Raider'd Folly"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Heavy Blow",
          build: "Hellfire",
          variant: "PvP",
          gear: {
            weapon: "Ancestor",
            helmet: "Crown of Madness",
            cuirass: "Eternal Ruler's Dominion",
            belt: "Eternal Ruler's Design",
            greaves: "Eternal Ruler's Gaze",
            pauldron: "Demonbane Pauldron",
            bracers: "Hand of Annihilation",
            gauntlet: "Ruler's Gauntlets",
            boots: "Eternal Ruler's Mark",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {}
        },
        {
          class: "Savage",
          coreSkill: "Heavy Blow",
          build: "Ice Blast",
          variant: "PvE",
          gear: {
            weapon: "Demonic Barb",
            helmet: "Crown of Decay",
            cuirass: "Eternal Ruler's Dominion",
            belt: "Eternal Ruler's Design",
            greaves: "Eternal Ruler's Gaze",
            pauldron: "Eternal Ruler's Resolve",
            bracers: "Hand of Annihilation",
            gauntlet: "Eternal Ruler's Shackles",
            boots: "Eternal Ruler's Mark",
            necklace: "Obsidian Heart",
            amulet: "Bloodhowl Charm",
            ring: "Dragon's Might"
          },
          alternatives: {
            weapon: ["Tribal Reverence"],
            helmet: ["Crown of Madness"],
            necklace: ["Ironblood Soul"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Heavy Blow",
          build: "Thunderbolt",
          variant: "PvE",
          gear: {
            weapon: "Tribal Reverence",
            helmet: "Crown of Decay",
            cuirass: "Eternal Ruler's Dominion",
            belt: "Eternal Ruler's Design",
            greaves: "Eternal Ruler's Gaze",
            pauldron: "Demonbane Pauldron",
            bracers: "Hand of Annihilation",
            gauntlet: "Ancestral Legacy",
            boots: "Eternal Ruler's Mark",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Dragon's Might"
          },
          alternatives: {
            gauntlet: ["Ruler's Gauntlets", "Eternal Ruler's Shackles"],
            boots: ["Raider'd Folly"]
          }
        },
        {
          class: "Savage",
          coreSkill: "Heavy Blow",
          build: "Thunderbolt",
          variant: "PvP",
          gear: {
            weapon: "Ancestor",
            helmet: "Crown of Decay",
            cuirass: "Eternal Ruler's Dominion",
            belt: "Eternal Ruler's Design",
            greaves: "Eternal Ruler's Gaze",
            pauldron: "Demonbane Pauldron",
            bracers: "Hand of Annihilation",
            gauntlet: "Ancestral Legacy",
            boots: "Eternal Ruler's Mark",
            necklace: "Ironblood Soul",
            amulet: "Bloodhowl Charm",
            ring: "Wildsoul Pact"
          },
          alternatives: {}
        }
      ];

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function titleCase(s) {
        if (!s) return "";
        return s.charAt(0).toUpperCase() + s.slice(1);
      }

      function wikiUrlForBuild(buildName) {
        const slug = String(buildName || "").trim().split(" ").filter(Boolean).join("_");
        return WIKI_BASE + encodeURIComponent(slug);
      }

      function emptyInventory() {
        const inv = {};
        for (const slot of slots) inv[slot] = new Set();
        return inv;
      }

      function loadInventory(cls) {
        const inv = emptyInventory();
        try {
          const raw = localStorage.getItem(storageKeyFor(cls));
          if (!raw) return inv;
          const obj = JSON.parse(raw);
          for (const slot of slots) {
            const arr = obj && obj[slot];
            if (Array.isArray(arr)) {
              for (const it of arr) inv[slot].add(normalizeItemName(it));
            }
          }
        } catch (e) {}
        return inv;
      }

      function saveInventory(inv, cls) {
        const obj = {};
        for (const slot of slots) obj[slot] = Array.from(inv[slot]);
        localStorage.setItem(storageKeyFor(cls), JSON.stringify(obj));
      }

      // Active class is controlled by the TOP buttons
      let activeClass = "Arcanist";
      let inventory = loadInventory(activeClass);

      function getFilteredBuilds() {
        return builds.filter(b => b.class === activeClass);
      }

      function buildItemCatalog(filteredBuilds) {
        const bySlot = {};
        for (const slot of slots) bySlot[slot] = [];

        for (const b of filteredBuilds) {
          for (const slot of slots) {
            const req = b.gear && b.gear[slot];
            if (req) bySlot[slot].push(normalizeItemName(req));
            const alts = (b.alternatives && b.alternatives[slot]) ? b.alternatives[slot] : [];
            for (const a of alts) bySlot[slot].push(normalizeItemName(a));
          }
        }

        const uniqSorted = {};
        for (const slot of slots) {
          const seen = new Set();
          const out = [];
          for (const it of bySlot[slot]) {
            const item = normalizeItemName(it);
            if (!item) continue;
            if (seen.has(item)) continue;
            seen.add(item);
            out.push(item);
          }
          out.sort((a, b) => a.localeCompare(b));
          uniqSorted[slot] = out;
        }

        return uniqSorted;
      }

      // Playable = every required slot has either optimal item OR one of the listed substitutes.
      // Optimal % = how many optimal (required) items you own / total required.
      function buildScore(build) {
        let requiredCount = 0;
        let optimalOwned = 0;
        let playable = true;

        for (const slot of slots) {
          const requiredRaw = build.gear && build.gear[slot];
          if (!requiredRaw) continue;

          const required = normalizeItemName(requiredRaw);
          requiredCount++;

          const hasReq = inventory[slot].has(required);
          if (hasReq) optimalOwned++;

          const altsRaw = (build.alternatives && build.alternatives[slot]) ? build.alternatives[slot] : [];
          const ownedAlt = altsRaw.map(normalizeItemName).find(a => inventory[slot].has(a));

          if (!hasReq && !ownedAlt) playable = false;
        }

        const optimalPct = requiredCount ? Math.round((optimalOwned / requiredCount) * 100) : 0;
        return { requiredCount, optimalOwned, optimalPct, playable };
      }

      function buildGearBreakdown(build) {
        const rows = [];

        for (const slot of slots) {
          const reqRaw = build.gear && build.gear[slot];
          if (!reqRaw) continue;

          const required = normalizeItemName(reqRaw);
          const altsRaw = (build.alternatives && build.alternatives[slot]) ? build.alternatives[slot] : [];
          const altList = altsRaw.map(normalizeItemName).filter(Boolean);

          const hasRequired = inventory[slot].has(required);
          const ownedAlts = altList.filter(a => inventory[slot].has(a));

          rows.push({ slot, required, altList, hasRequired, ownedAlts });
        }

        return rows;
      }

      // Item names are wrapped in <span class="item"> so they are always white.
      function gearDetailsHtml(build) {
        const key = buildKey(build);
        const isOpen = openDetails.has(key);
        const rows = buildGearBreakdown(build);
        const wiki = wikiUrlForBuild(build.build);

        let html = '<details ' + (isOpen ? 'open ' : '') + 'data-buildkey="' + escapeHtml(key) + '"><summary>Build details</summary>';
        html += '<div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">';
        html += '<a href="' + escapeHtml(wiki) + '" target="_blank" rel="noopener" style="color: var(--warn); text-decoration: none; font-weight: 900;">Open wiki page</a>';
        html += '<span class="small">(opens in new tab)</span>';
        html += '</div>';

        html += '<div style="margin-top:10px;"><ul>';

        for (const r of rows) {
          const slotLbl = '<b>' + escapeHtml(slotLabel(r.slot)) + '</b>: ';

          // Own optimal
          if (r.hasRequired) {
            html += '<li><span class="ok">✓</span> ' + slotLbl + '' + itemSpan(r.required) + ' <span class="small">(optimal)</span>';

            if (r.ownedAlts.length > 0) {
              const ownedAltStr = r.ownedAlts.map(a => '' + itemSpan(a) + '').join(', ');
              html += '<div class="small" style="margin-left:22px; margin-top:2px;">Also owned substitutes: ' + ownedAltStr + '</div>';
            }

            html += '</li>';
            continue;
          }

          // Own substitute only
          if (r.ownedAlts.length > 0) {
            html += '<li><span class="warn">~</span> ' + slotLbl + '' + itemSpan(r.ownedAlts[0]) + ' <span class="small">(playable, not optimal)</span>';
            html += '<div class="small" style="margin-left:22px; margin-top:2px;">Optimal item: ' + itemSpan(r.required) + '</div>';

            const extraAlts = r.ownedAlts.slice(1);
            if (extraAlts.length > 0) {
              const extraStr = extraAlts.map(a => '<span class="item">' + escapeHtml(a) + '</span>').join(', ');
              html += '<div class="small" style="margin-left:22px; margin-top:2px;">Other owned substitutes: ' + extraStr + '</div>';
            }

            html += '</li>';
            continue;
          }

          // Missing
          html += '<li><span class="bad">✗</span> ' + slotLbl + '<span class="item">' + escapeHtml(r.required) + '</span> <span class="small">(missing)</span>';
          if (r.altList.length > 0) {
            const subsStr = r.altList.map(a => '<span class="item">' + escapeHtml(a) + '</span>').join(', ');
            html += '<div class="small" style="margin-left:22px; margin-top:2px;">Substitutes: ' + subsStr + '</div>';
          }
          html += '</li>';
        }

        html += '</ul></div></details>';
        return html;
      }

      function renderBuilds() {
        const out = document.getElementById("buildResults");
        const playableOnly = document.getElementById("showPlayableOnly").checked;
        const sortByOptimal = document.getElementById("sortByOptimal").checked;

        const filteredBuilds = getFilteredBuilds();
        if (!filteredBuilds.length) {
          out.innerHTML = '<div class="hint">No ' + escapeHtml(activeClass) + ' builds added yet.</div>';
          return;
        }

        let rows = filteredBuilds.map(b => ({ b, s: buildScore(b) }));
        if (playableOnly) rows = rows.filter(r => r.s.playable);
        if (sortByOptimal) rows.sort((a, b) => b.s.optimalPct - a.s.optimalPct);

        out.innerHTML = "";
        for (const row of rows) {
          const b = row.b;
          const s = row.s;

          const playableLabel = (() => {
            if (!s.playable) return '<span class="incomplete">Incomplete</span>';
            if (s.optimalPct === 100) return '<span class="ok">Playable (optimal)</span>';
            return '<span class="warn">Playable (using substitutes)</span>';
          })();
	  const isAncientGod = String(b.variant || "").includes("Ancient God");


          const div = document.createElement("div");
          div.className = "build";
div.innerHTML =
  '<h3>' + escapeHtml(b.build) + ' – ' + escapeHtml(b.variant) + '</h3>' +
  (isAncientGod
    ? '<div class="ag-warning">Warning: This build requires 15% or more Hail CD</div>'
    : ''
  ) +
  '<div class="meta">' + escapeHtml(b.class) + ' • ' + escapeHtml(b.coreSkill) + ' • ' +
    s.optimalOwned + '/' + s.requiredCount + ' optimal</div>' +
  '<div class="progress">Optimal: ' + s.optimalPct + '%</div>' +
  '<div style="margin-top:6px;">' + playableLabel + '</div>' +
  gearDetailsHtml(b);


          out.appendChild(div);
        }

        // Restore and persist open/closed state for detail panels
        out.querySelectorAll('details[data-buildkey]').forEach(d => {
          d.addEventListener('toggle', () => {
            const k = d.getAttribute('data-buildkey');
            if (!k) return;
            if (d.open) openDetails.add(k);
            else openDetails.delete(k);
          });
        });
      }

      function renderInventory() {
        const grid = document.getElementById("invGrid");
        grid.innerHTML = "";

        const filteredBuilds = getFilteredBuilds();
        if (!filteredBuilds.length) {
          grid.innerHTML = '<div class="hint">No ' + escapeHtml(activeClass) + ' items yet (add builds for this class to populate the item list).</div>';
          return;
        }

        const catalog = buildItemCatalog(filteredBuilds);

        for (const slot of slots) {
          const wrap = document.createElement("div");
          wrap.className = "slot";

          const items = catalog[slot];
          const countOwned = inventory[slot].size;

          let html = '<label>' + escapeHtml(slotLabel(slot)) + ' <span class="small">(' + countOwned + ' owned)</span></label>';

          if (!items.length) {
            html += '<div class="hint">No items loaded for this slot.</div>';
            wrap.innerHTML = html;
            grid.appendChild(wrap);
            continue;
          }

          html += '<div>';
          for (const item of items) {
            const id = ('cb_' + slot + '_' + item).replaceAll(' ', '_').replaceAll("'", "");
            const checked = inventory[slot].has(item) ? 'checked' : '';
            html +=
              '<div style="display:flex; gap:10px; align-items:flex-start; margin:6px 0;">' +
                '<input type="checkbox" id="' + escapeHtml(id) + '" data-slot="' + escapeHtml(slot) + '" data-item="' + escapeHtml(item) + '" ' + checked + ' />' +
                '<label for="' + escapeHtml(id) + '" class="' + itemClass(item) + '" style="margin:0; cursor:pointer;">' + escapeHtml(item) + '</label>' +
              '</div>';
          }
          html += '</div>';

          wrap.innerHTML = html;
          grid.appendChild(wrap);
        }

        grid.querySelectorAll('input[type=checkbox]').forEach(cb => {
          cb.addEventListener('change', (e) => {
            const slot = e.target.getAttribute('data-slot');
            const item = normalizeItemName(e.target.getAttribute('data-item'));
            if (!slot || !item) return;

            if (e.target.checked) inventory[slot].add(item);
            else inventory[slot].delete(item);

            saveInventory(inventory, activeClass);
            renderBuilds();
            renderInventory();
          });
        });
      }

      // --- Minimal self-tests (runs in console; does not affect UI) ---
      function runSelfTests() {
        try {
          console.assert(normalizeItemName("Ancient God Call") === "Ancient God's Call", "normalize alias: Ancient God Call");
          console.assert(normalizeItemName("Pack Binding") === "Pact Binding", "normalize alias: Pack Binding");
          console.assert(normalizeItemName("Dragon Hyun Walker") === "Dragon Hymn Walker", "normalize alias: Dragon Hyun Walker");

          const arcanistCount = builds.filter(b => b.class === "Arcanist").length;
          const savageCount = builds.filter(b => b.class === "Savage").length;
          console.assert(arcanistCount > 0, "self-test: should have Arcanist builds");
          console.assert(savageCount > 0, "self-test: should have Savage builds");

          const inv = emptyInventory();
          inv.weapon.add("Fate Intertwined");
          inventory = inv;
          const score = buildScore(builds.find(b => b.class === "Arcanist"));
          console.assert(typeof score.optimalPct === "number", "self-test: buildScore returns numbers");
        } catch (e) {
          console.warn("Self-tests failed:", e);
        }
      }

      // --- Controls ---
      function setActiveClass(cls) {
        if (cls !== "Arcanist" && cls !== "Savage") return;

        // persist current inventory first
        saveInventory(inventory, activeClass);

        activeClass = cls;
        inventory = loadInventory(activeClass);

        // button UI
        const aBtn = document.getElementById("btnArcanist");
        const sBtn = document.getElementById("btnSavage");
        aBtn.classList.toggle("active", activeClass === "Arcanist");
        sBtn.classList.toggle("active", activeClass === "Savage");

        renderInventory();
        renderBuilds();
      }

      document.getElementById("btnArcanist").addEventListener("click", () => setActiveClass("Arcanist"));
      document.getElementById("btnSavage").addEventListener("click", () => setActiveClass("Savage"));

      document.getElementById('clearBtn').addEventListener('click', () => {
        if (confirm('Clear your saved ' + activeClass + ' inventory?')) {
          inventory = emptyInventory();
          saveInventory(inventory, activeClass);
          renderInventory();
          renderBuilds();
        }
      });

      document.getElementById('saveBtn').addEventListener('click', () => {
        saveInventory(inventory, activeClass);
        renderBuilds();
      });

      document.getElementById('showPlayableOnly').addEventListener('change', renderBuilds);
      document.getElementById('sortByOptimal').addEventListener('change', renderBuilds);

      // Init
      runSelfTests();
      setActiveClass("Arcanist");
    });
  </script>
</body>
</html>
